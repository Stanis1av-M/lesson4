
## Глава 5. Проектирование отказоустойчивых механизмов проведения документов

В архитектуре «1С» процедура проведения — это не просто запись данных, а сложный транзакционный процесс, обеспечивающий достоверность учета. Рассматриваемый алгоритм базируется на принципе **«прерывания при несоответствии»**, что является стандартом разработки высоконадежных систем.

---

### Граф I. Инициализация транзакции и фильтрация событий

Перед выполнением тяжелых операций (запросов к БД) система должна определить область ответственности и проверить правомерность выполнения бизнес-процесса.

1. **Управление записью наборов (Движения)**
Свойство `.Записывать` управляет поведением менеджера записи. Установка этого флага в `Истина` инициализирует пустые наборы записей в оперативной памяти. Это позволяет платформе оптимизировать SQL-запросы: данные будут записаны в базу одним пакетом в самом конце транзакции, что существенно снижает нагрузку на дисковую подсистему.
```bsl
// Включаем запись для трех регистров, которые будут задействованы в документе
Движения.ОстаткиТоваров.Записывать = Истина;
Движения.СебестоимостьТоваров.Записывать = Истина;
Движения.ЗатратыНаВыпуск.Записывать = Истина;

```


2. **Семантическая валидация (Статусная модель)**
Использование перечислений для контроля логики проведения — лучший способ избежать ошибок «человеческого фактора». Оператор `Возврат` в данном контексте завершает процедуру без ошибки, но и без формирования движений. Это критично для документов, находящихся в черновиках или на этапах согласования.
```bsl
// Если производство еще не завершено, движения по регистрам не делаем (выходим)
Если Статус <> Перечисления.СтатусыЭтапов.Завершен Тогда 
    Возврат; 
КонецЕсли;

```


3. **Подготовка и агрегация данных (Свертка ТЗ)**
Метод `Свернуть` выполняет группировку строк по ключевым полям (измерениям) и суммирует ресурсы. Это необходимо для корректного контроля остатков: если в документе одна и та же номенклатура указана в двух строках по 5 штук, запрос должен сравнивать суммарную потребность (10 шт.) с остатком на складе.
```bsl
// Подготовка данных: выгружаем таблицу материалов и сворачиваем (суммируем) дубли номенклатуры
ТЗ = Материалы.Выгрузить();
ТЗ.Свернуть("Номенклатура", "Количество");

```



---

### Граф II. Транзакционный контроль и работа с запросами

На этом этапе происходит взаимодействие с СУБД для проверки физической возможности совершения операции.

1. **Временные таблицы (Temporary Tables)**
Механизм `ПОМЕСТИТЬ` позволяет загрузить данные из оперативной памяти (объект `ТаблицаЗначений`) во временную таблицу на стороне SQL-сервера. Это на порядок ускоряет работу, так как последующее соединение происходит внутри одной СУБД-сессии без пересылки данных обратно в 1С.
```bsl
Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	Т.Номенклатура КАК Номенклатура,
|	Т.Количество КАК Количество
|ПОМЕСТИТЬ ВТ ИЗ &ТЗ КАК Т;"

```


2. **Метод «Левого соединения» и виртуальные таблицы**
Виртуальная таблица `.Остатки` — это мощный инструмент 1С, который не сканирует все записи регистра с начала времен, а обращается к заранее рассчитанным итогам. Соединение с `ЕСТЬNULL` гарантирует стабильность алгоритма: если товара нет на складе, система получит 0 вместо `Null`, что позволит вычислить математическую разность (нехватку).
```bsl
|ВЫБРАТЬ
		|	ВТ.Номенклатура КАК Номенклатура,
		|	ВТ.Количество - ЕСТЬNULL(Ост.КоличествоОстаток, 0) КАК Нехватка
		|ИЗ ВТ КАК ВТ
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиТоваров.Остатки(&Момент, Склад = &Склад) КАК Ост
		|ПО ВТ.Номенклатура = Ост.Номенклатура
		|ГДЕ ВТ.Количество > ЕСТЬNULL(Ост.КоличествоОстаток, 0)"; // Находим только те позиции, где расход > остатка

```


3. **Параметр «Момент времени»**
В 1С время дискретно. `МоментВремени()` — это комбинация даты и ссылки на документ. Передача этого параметра в запрос гарантирует, что мы видим остатки **до** текущего документа (если он новый) или **с учетом** его текущего положения, что исключает «эффект грязного чтения».
```bsl
Запрос.УстановитьПараметр("ТЗ", ТЗ);
Запрос.УстановитьПараметр("Склад", СкладМатериалов);
Запрос.УстановитьПараметр("Момент", МоментВремени());

```


4. **Механизм обратной связи и прерывание транзакции**
Объект `СообщениеПользователю` обеспечивает интерактивность. Установка `Отказ = Истина` — это команда системе инициировать процедуру `Rollback` в SQL. Все изменения, которые могли быть сделаны до этого момента, будут стерты, а пользователь получит четкое уведомление о причине сбоя.
```bsl
Выборка = Запрос.Выполнить().Выбрать();
Если Выборка.Следующий() Тогда
    Сообщение = Новый СообщениеПользователю;
    Сообщение.Текст = "Не хватает материала: " + Выборка.Номенклатура + ". Не хватает: " + Выборка.Нехватка;
    Сообщение.Сообщить();
    Отказ = Истина; Возврат;
КонецЕсли;

```



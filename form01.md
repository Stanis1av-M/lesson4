    &НаКлиенте
    // Основная процедура, вызываемая нажатием кнопки на форме.
    Процедура СформироватьЭтапы(Команда)
	
	// Вызываем серверную функцию для проверки, не создавались ли документы по этому заказу ранее.
	ЕстьДубли = ПроверитьДублиНаСервере();
	
	// Если документы уже найдены в базе данных.
	Если ЕстьДубли Тогда
		
		// Формируем текст предупреждения для пользователя (Символы.ПС — перенос строки).
		ТекстВопроса = "ВНИМАНИЕ: По этому заказу этапы УЖЕ были созданы ранее! " + Символы.ПС +
		               "Вы хотите создать ДУБЛИ (еще один комплект документов)?";
		
		// Описываем процедуру ("ПослеОтветаНаВопрос"), которая запустится после того, как пользователь нажмет кнопку в диалоге.
		Оповещение = Новый ОписаниеОповещения("ПослеОтветаНаВопрос", ЭтотОбъект);
		
		// Выводим окно вопроса с кнопками "Да" и "Нет".
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		
	Иначе
		// Если дублей нет, сразу переходим к созданию документов на сервере.
		СформироватьЭтапыНаСервере();
		Сообщить("Этапы сформированы успешно.");
	КонецЕсли;
	
    КонецПроцедуры

    &НаКлиенте
    // Процедура-обработчик ответа пользователя на вопрос о дублях.
    Процедура ПослеОтветаНаВопрос(Результат, ДополнительныеПараметры) Экспорт
	
	// Если пользователь осознанно нажал кнопку "Да".
	Если Результат = КодВозвратаДиалога.Да Тогда
		// Создаем еще один комплект документов на сервере.
		СформироватьЭтапыНаСервере();
		Сообщить("Внимание: Были созданы дополнительные этапы (дубли).");
	Иначе
		// Если пользователь нажал "Нет", выводим информацию об отмене.
		Сообщить("Создание отменено.");
	КонецЕсли;
	
    КонецПроцедуры

    &НаСервере
    // Функция для поиска уже существующих документов в базе данных.
    Функция ПроверитьДублиНаСервере()
	
	// Создаем новый объект "Запрос" для обращения к таблицам БД.
	Запрос = Новый Запрос;
	// Текст запроса: ищем хотя бы одну ссылку в документах "ВыполнениеЭтапаПроизводства".
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1 
		|	Ссылка 
		|ИЗ 
		|	Документ.ВыполнениеЭтапаПроизводства 
		|ГДЕ 
		|	ЗаказНаОсновании = &ТекЗаказ И НЕ ПометкаУдаления"; // Фильтр по заказу и исключение удаленных.
		
	// Подставляем ссылку текущего документа в параметр запроса.
	Запрос.УстановитьПараметр("ТекЗаказ", Объект.Ссылка);
	
	// Возвращаем Истина, если запрос нашел записи, и Ложь, если результат пустой.
	Возврат НЕ Запрос.Выполнить().Пустой();
	
    КонецФункции

    &НаСервере
    // Процедура создания новых документов на основании табличной части текущего объекта.
        Процедура СформироватьЭтапыНаСервере()
	
	// Обходим каждую строку в табличной части "СписокИзделий" текущего объекта (Заказа).
	Для Каждого СтрокаЗаказа Из Объект.СписокИзделий Цикл 
		
		// Инициализируем создание нового пустого документа нужного типа.
		НовыйДок = Документы.ВыполнениеЭтапаПроизводства.СоздатьДокумент();
		
		// Заполняем реквизиты нового документа.
		НовыйДок.Дата = ТекущаяДата(); // Текущее системное время.
		НовыйДок.Статус = Перечисления.СтатусЭтапов.Запланирован; // Установка начального статуса.
		
		НовыйДок.ЗаказНаОсновании = Объект.Ссылка; // Связываем новый документ с текущим заказом.
		НовыйДок.ВыходноеИзделие = СтрокаЗаказа.Номенклатура; // Какое изделие производим.
		НовыйДок.КоличествоВыход = СтрокаЗаказа.Количество; // Сколько единиц производим.
		
		// Блок защиты от ошибок при работе со спецификациями.
		Попытка
			// Если в строке заказа указана спецификация (рецептура производства).
			Если ЗначениеЗаполнено(СтрокаЗаказа.Спецификация) Тогда
				Спец = СтрокаЗаказа.Спецификация;
				
				// Переносим материалы из спецификации в новый документ.
				Для Каждого СтрСпец Из Спец.Materials Цикл // Предполагается, что ТЧ называется Материалы или Materials
					Нов = НовыйДок.Материалы.Добавить();
					Нов.Номенклатура = СтрСпец.Номенклатура;
					// Рассчитываем нужное количество материала на весь объем изделия.
					Нов.Количество = СтрСпец.Количество * СтрокаЗаказа.Количество;
				КонецЦикла;
			КонецЕсли;
		Исключение
			// В случае ошибки (например, неверное имя ТЧ в спецификации) программа просто продолжит работу.
		КонецПопытки;

		// Физически записываем созданный документ в базу данных без проведения.
		НовыйДок.Записать(РежимЗаписиДокумента.Запись);
		
	КонецЦикла; // Переход к следующему изделию в списке.

    КонецПроцедуры

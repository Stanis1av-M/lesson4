// Объявление основной процедуры проведения документа
Процедура ОбработкаПроведения(Отказ, Режим)
	
	// Выгружаем табличную часть "Материалы" в таблицу значений для обработки в памяти
	ТЗ_Док = Материалы.Выгрузить();
	// Сворачиваем таблицу по номенклатуре, суммируя количество (чтобы корректно проверить остаток, если товар в документе дублируется)
	ТЗ_Док.Свернуть("Номенклатура", "Количество");
	
	// Инициализируем объект "Запрос" для получения данных из базы
	Запрос = Новый Запрос;
	// Текст запроса к виртуальной таблице "Остатки" регистра накопления
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Ост.Номенклатура КАК Номенклатура,
		|	ISNULL(Ост.КоличествоОстаток, 0) КАК ВНаличии // Если остатка нет, заменяем Null на 0
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваров.Остатки(&Момент, 
		|		Склад = &СкладОтпр И Номенклатура В (&СписокТоваров)) КАК Ост";
	
	// Передаем параметры в запрос: момент времени документа, склад-отправитель и список товаров из ТЧ
	Запрос.УстановитьПараметр("Момент", МоментВремени());
	Запрос.УстановитьПараметр("СкладОтпр", СкладОтправитель);
	Запрос.УстановитьПараметр("СписокТоваров", ТЗ_Док.ВыгрузитьКолонку("Номенклатура"));
	
	// Выполняем запрос и выгружаем результат в таблицу значений "ТаблицаОстатков"
	ТаблицаОстатков = Запрос.Выполнить().Выгрузить();
	// Добавляем индекс по колонке "Номенклатура" для ускорения поиска в таблице
	ТаблицаОстатков.Индексы.Добавить("Номенклатура");

	// Начинаем обход свернутой таблицы товаров из документа
	Для Каждого Стр ИЗ ТЗ_Док Цикл
		
		// Проверяем корректность типа данных и инициализируем переменную количества для списания
		НадоСписать = 0;
		Если ТипЗнч(Стр.Количество) = Тип("Число") Тогда
			НадоСписать = Стр.Количество;
		КонецЕсли;
		
		// Ищем текущий товар в полученной из базы таблице остатков
		ЕстьНаСкладе = 0;
		НайденныеСтроки = ТаблицаОстатков.НайтиСтроки(Новый Структура("Номенклатура", Стр.Номенклатура));
		
		// Если товар найден в таблице остатков — получаем числовое значение
		Если НайденныеСтроки.Количество() > 0 Тогда
			ЗначениеИзБазы = НайденныеСтроки[0].ВНаличии;
			Если ТипЗнч(ЗначениеИзБазы) = Тип("Число") Тогда
				ЕстьНаСкладе = ЗначениеИзБазы;
			КонецЕсли;
		КонецЕсли;
		
		// Главная проверка: если количество в документе больше, чем есть на складе
		Если НадоСписать > ЕстьНаСкладе Тогда
			
			// Создаем и выводим сообщение об ошибке пользователю
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Не хватает товара: " + Стр.Номенклатура + 
			                  ". Требуется: " + НадоСписать + ", В наличии: " + ЕстьНаСкладе;
			Сообщение.Сообщить();
			// Устанавливаем флаг Отказ, чтобы система прервала проведение
			Отказ = Истина; 
		КонецЕсли;
	КонецЦикла;
	
	// Если хотя бы одного товара не хватило — выходим из процедуры, не делая движений
	Если Отказ Тогда 
		Возврат; 
	КонецЕсли;

	// Если проверка пройдена успешно — разрешаем запись в регистр
	Движения.ОстаткиТоваров.Записывать = Истина;
	// Проходим по исходной табличной части (не свернутой), чтобы сформировать движения
	Для Каждого ТекСтрока Из Материалы Цикл
		
		// Формируем движение Расхода: уменьшаем остаток на складе-отправителе
		ДвРасход = Движения.ОстаткиТоваров.Добавить();
		ДвРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
		ДвРасход.Период = Дата;
		ДвРасход.Склад = СкладОтправитель;
		ДвРасход.Номенклатура = ТекСтрока.Номенклатура;
		ДвРасход.Количество = ТекСтрока.Количество;
		
		// Формируем движение Прихода: увеличиваем остаток на складе-получателе
		ДвПриход = Движения.ОстаткиТоваров.Добавить();
		ДвПриход.ВидДвижения = ВидДвиженияНакопления.Приход;
		ДвПриход.Период = Дата;
		ДвПриход.Склад = СкладПолучатель;
		ДвПриход.Номенклатура = ТекСтрока.Номенклатура;
		ДвПриход.Количество = ТекСтрока.Количество;
		
	КонецЦикла;

КонецПроцедуры



## Граф I. Событийная модель и транзакционная логика проведения

В этом блоке рассматривается «жизненный цикл» документа в момент его проведения. Проведение в 1С — это критически значимое действие, которое меняет состояние учета в системе.

### 1. Обработчик «ОбработкаПроведения»

Процедура `ОбработкаПроведения` является «сердцем» модуля документа. Она выполняется строго на **сервере** в рамках неявной **транзакции**. Это гарантирует, что если в процессе выполнения возникнет ошибка или переменная `Отказ` станет равной `Истина`, система выполнит «откат» (Rollback), и ни одна запись не попадет в базу данных.

```bsl
// Параметр "Отказ" позволяет остановить проведение при ошибке.
// Параметр "Режим" указывает на вид проведения (Оперативный или Неоперативный).
Процедура ОбработкаПроведения(Отказ, Режим)

```

### 2. Коллекция «Движения» и флаг записи

Одной из ключевых особенностей платформы является свойство `.Записывать = Истина`. Платформа не записывает данные в таблицы SQL после каждой итерации цикла. Вместо этого она накапливает их в оперативной памяти и совершает массовый «сброс» в базу только по завершении процедуры.

```bsl
// Разрешаем запись движений в регистры по окончании процедуры.
Движения.ОстаткиТоваров.Записывать = Истина;
Движения.СебестоимостьТоваров.Записывать = Истина;

```

### 3. Циклическая обработка табличных частей

Для отражения данных в учете используется обход коллекций документа. Важно понимать, что внутри цикла мы работаем с локальной переменной строки (`ТекСтрока`), из которой черпаем аналитику для будущих записей.

```bsl
// Начинаем перебор строк табличной части "Материалы".
Для Каждого ТекСтрока Из Материалы Цикл
    // Создаем новую запись (строку) в наборе движений регистра "ОстаткиТоваров".
		ДвижениеОст = Движения.ОстаткиТоваров.Добавить();
		
		// Устанавливаем тип движения: Приход (увеличение остатка).
		ДвижениеОст.ВидДвижения = ВидДвиженияНакопления.Приход;
		
		// Указываем дату движения, равную дате самого документа.
		ДвижениеОст.Период = Дата;
		
		// Заполняем измерения регистра из шапки документа ("Склад") и строки таблицы ("Номенклатура").
		ДвижениеОст.Склад = Склад;
		ДвижениеОст.Номенклатура = ТекСтрока.Номенклатура;
		
		// Заполняем ресурс регистра — количество товара.
		ДвижениеОст.Количество = ТекСтрока.Количество;
		
		// Создаем новую запись в наборе движений регистра "СебестоимостьТоваров".
		ДвижениеСеб = Движения.СебестоимостьТоваров.Добавить();
		
		// Устанавливаем тип движения: Приход (поступление стоимости).
		ДвижениеСеб.ВидДвижения = ВидДвиженияНакопления.Приход;
		
		// Указываем дату записи в регистр.
		ДвижениеСеб.Период = Дата;
		
		// Заполняем аналитику (измерения) регистра стоимости.
		ДвижениеСеб.Номенклатура = ТекСтрока.Номенклатура;
		
		// Заполняем количественный ресурс.
		ДвижениеСеб.Количество = ТекСтрока.Количество;
		
		// Заполняем стоимостной ресурс из колонки "Сумма" табличной части.
		ДвижениеСеб.Стоимость = ТекСтрока.Сумма; 		

КонецЦикла;

```

---

## Граф II. Архитектура учетных механизмов: Регистры накопления

Этот блок описывает, как данные распределяются по физическим таблицам базы данных и какую структуру они имеют.

### 1. Измерения и Ресурсы

Ваш код наглядно демонстрирует заполнение структуры регистра. В 1С регистр — это многомерная система координат:

* **Измерения** (`Склад`, `Номенклатура`, `Партия`): Это «разрезы» учета, отвечающие на вопросы «Где?» и «Что?».
* **Ресурсы** (`Количество`, `Стоимость`): Это числовые показатели, отвечающие на вопрос «Сколько?».

```bsl
// Заполнение измерений и ресурсов регистра "ОстаткиТоваров"
ДвижениеОст.Склад = Склад;
ДвижениеОст.Номенклатура = ТекСтрока.Номенклатура;
ДвижениеОст.Количество = ТекСтрока.Количество;

```

### 2. Логика «Прихода» и временная ось

Использование `ВидДвиженияНакопления.Приход` определяет вектор изменения состояния (увеличение остатка). Важным атрибутом является `Период` — он привязывает запись к временной шкале, что позволяет системе рассчитывать итоги на любой момент времени.

```bsl
ДвижениеОст.ВидДвижения = ВидДвиженияНакопления.Приход;
ДвижениеОст.Период = Дата; // Время записи обычно совпадает с датой документа

```

### 3. Ссылочная идентичность и Партионный учет

В 1С реализован механизм, где документ может ссылаться на самого себя как на источник данных. Это критично для финансового учета, где нужно знать, какой именно приход сформировал текущую стоимость товара.

```bsl
// Заполняем аналитику партии — указываем ссылку на этот же текущий документ.
ДвижениеСеб.Партия = Ссылка; 
ДвижениеСеб.Стоимость = ТекСтрока.Сумма;

 
 § 4.2. Программная валидация данных в модуле объекта

В процессе разработки конфигураций одной из важнейших задач является обеспечение **логической целостности** данных. В то время как ссылочная целостность поддерживается платформой автоматически, контроль бизнес-логики возлагается на обработчик события **ПередЗаписью**.

### Принципы работы механизма «Отказ»

Событие `ПередЗаписью` предоставляет разработчику параметр `Отказ` (тип: *Булево*). Присвоение этому параметру значения `Истина` приводит к прерыванию транзакции записи. Это критически важно для предотвращения ошибочных операций, таких как попытка выпуска сырья в качестве готовой продукции.

### Реализация проверки реквизитов шапки

При обращении к реквизитам объекта (например, `ВыходноеИзделие`) система выполняет чтение данных. Если реквизит является ссылочным, разработчик может обращаться к его свойствам через точку. Рассмотрим фрагмент кода:

```bsl
Если ЗначениеЗаполнено(ВыходноеИзделие) Тогда
    // Обращение через точку к реквизиту справочника Номенклатура
    Если ВыходноеИзделие.ТипНоменклатуры = Перечисления.ТипНоменклатуры.Сырье Тогда
        Отказ = Истина;
        // Формирование уведомления пользователю
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Нельзя производить сырье. Исправьте поле Выходное изделие";
        Сообщение.Сообщить();
    КонецЕсли;
КонецЕсли;

```

**Ключевой момент:** Использование функции `ЗначениеЗаполнено()` предотвращает обращение к свойствам пустой ссылки, что могло бы привести к ошибке времени выполнения.

### Проверка коллекций (Табличных частей)

Валидация табличных частей требует обхода всех строк коллекции. При этом важно не просто запретить запись, но и указать пользователю на **конкретную строку**, содержащую ошибку.

Для этого используется объект `СообщениеПользователю` с заполнением следующих свойств:

* **Текст**: Описание проблемы.
* **Поле**: Строковый путь к элементу формы (индексация строк в 1С начинается с 0, поэтому используется формула `НомерСтроки - 1`).
* **УстановитьДанные()**: Метод, связывающий сообщение с текущим объектом.

```bsl
Для каждого СтрокаТаблицы Из Материалы Цикл
    Если ЗначениеЗаполнено(СтрокаТаблицы.Номенклатура) Тогда
        // Проверка типа номенклатуры в строке ТЧ
        Если СтрокаТаблицы.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.ГотоваяПродукция Тогда
            Отказ = Истина;
            Сообщение = Новый СообщениеПользователю;
            Сообщение.Текст = "Нельзя Использовать Готовую продукцию ("+ СтрокаТаблицы.Номенклатура + ") в материалах";
            
            // Привязка сообщения к конкретной ячейке табличной части
            Сообщение.Поле = "Материалы["+(СтрокаТаблицы.НомерСтроки - 1) + "].Номенклатура";
            Сообщение.УстановитьДанные(ЭтотОбъект);
            Сообщение.Сообщить();
        КонецЕсли;
    КонецЕсли;
КонецЦикла;

```

### Типичные ошибки и рекомендации

1. **Производительность**: Обращение через точку в цикле (`СтрокаТаблицы.Номенклатура.ТипНоменклатуры`) заставляет платформу выполнять отдельный SQL-запрос для каждой строки. В высоконагруженных системах для таких проверок рекомендуется использовать предварительную выборку данных через **Запрос**.
2. **Типизация**: Всегда сравнивайте значения с элементами перечислений напрямую (`Перечисления.ТипыНоменклатуры.Имя`), избегая использования строковых литералов.
